<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Cloud Browser</title>
    <style>
      html,body { margin:0; height:100%; background:#000; }
      #bar { position:fixed; top:10px; left:10px; right:10px; display:flex; gap:8px; z-index:2 }
      input,button { padding:8px }
      #view { width:100vw; height:100vh; object-fit:contain; display:block }
    </style>
  </head>
  <body>
    <div id="bar">
      <input id="url" placeholder="https://example.com" style="flex:1"/>
      <button id="go">Go</button>
      <a href="/snap?url=https://example.com" target="_blank" style="color:#fff;">/snap test</a>
    </div>
    <img id="view"/>

    <script>
      const ws = new WebSocket(
        (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws'
      );

      ws.onopen = () => {
        console.log("WS OPEN");
        const u = new URLSearchParams(location.search).get('url') || "https://example.com";
        document.getElementById('url').value = u;
        try { ws.send(JSON.stringify({ type: "navigate", data: { url: u } })); }
        catch (e) { console.error("send on open failed", e); }
        setInterval(() => { if (ws.readyState === 1) ws.send('{"type":"ping"}'); }, 25000);
      };

      ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);
          if (msg.type === "frame" && msg.data) {
            document.getElementById("view").src = msg.data;
          }
        } catch (e) {
          console.error("parse error", e);
        }
      };

      ws.onclose = (ev) => {
        console.error("WS CLOSE", ev.code, ev.reason);
      };

      document.getElementById('go').onclick = () => {
        const u = document.getElementById('url').value.trim();
        if (ws.readyState === 1) ws.send(JSON.stringify({ type: "navigate", data: { url: u } }));
        else console.error("WS not open");
      };

      document.getElementById('view').addEventListener('click', (e) => {
        const rect = e.target.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        if (ws.readyState === 1) ws.send(JSON.stringify({ type: "click", data: { x, y } }));
      });

      window.addEventListener('wheel', (e) => {
        if (ws.readyState === 1) ws.send(JSON.stringify({ type: "scroll", data: { x: 0, y: window.scrollY + e.deltaY } }));
      });

      window.addEventListener('keydown', (e) => {
        if (e.key.length === 1 && ws.readyState === 1) ws.send(JSON.stringify({ type: "keypress", data: { text: e.key } }));
        if (e.key === 'Enter' && ws.readyState === 1) ws.send(JSON.stringify({ type: "keypress", data: { text: "\n" } }));
      });
    </script>
  </body>
</html>
